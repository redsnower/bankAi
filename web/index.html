<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bank AI Agent Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body{padding:20px}
      :root[data-theme='dark']{background:#0d1117;color:#c9d1d9}
      :root[data-theme='dark'] .card{background:#0b1220;border-color:#1f2a37}
      :root[data-theme='dark'] .table{color:#c9d1d9}
      :root[data-theme='dark'] .list-group-item{background:#071024;color:#c9d1d9}
      :root[data-theme='dark'] .btn-outline-secondary{border-color:#2b3746;color:#c9d1d9}
      #log{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:6px;height:160px;overflow:auto}
      .spinner-overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.6);align-items:center;justify-content:center;z-index:9999}
      .spinner-overlay.show{display:flex}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4">Bank AI Agent — Demo</h1>
        <div>
          <select id="user" class="form-select form-select-sm">
            <option>alice</option>
            <option>bob</option>
          </select>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Accounts</h5>
              <table class="table table-sm" id="accountsTable">
                <thead><tr><th>User</th><th>Balance</th><th>Currency</th></tr></thead>
                <tbody></tbody>
              </table>
              <button id="refreshBtn" class="btn btn-sm btn-outline-primary">Refresh</button>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Transfer</h5>
              <div class="row g-2 align-items-center">
                <div class="col-4"><input id="to" class="form-control form-control-sm" value="bob"></div>
                <div class="col-4"><input id="amount" type="number" class="form-control form-control-sm" value="100"></div>
                <div class="col-4"><button id="transferBtn" class="btn btn-sm btn-primary">Transfer</button></div>
              </div>
            </div>
          </div>

        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title d-flex justify-content-between align-items-center">Transaction History
                <div>
                  <input id="filterInput" class="form-control form-control-sm d-inline-block me-2" placeholder="filter by user" style="width:140px">
                  <button id="exportBtn" class="btn btn-sm btn-outline-success me-1">Export CSV</button>
                  <button id="clearBtn" class="btn btn-sm btn-outline-danger">Clear</button>
                </div>
              </h5>
              <ul class="list-group" id="historyList" style="max-height:300px;overflow:auto"></ul>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title d-flex justify-content-between align-items-center">Interaction Log
                <div>
                  <button id="themeBtn" class="btn btn-sm btn-outline-secondary">Toggle Theme</button>
                </div>
              </h5>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <small class="text-muted">Note: This demo uses an in-memory store. Reload resets state.</small>
      </div>
    </div>

    <div class="spinner-overlay" id="spinner"><div class="spinner-border text-primary" role="status"></div></div>

    <!-- Advice Modal -->
    <div class="modal fade" id="adviceModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">AI Advice</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body"><p id="adviceModalText"></p></div>
          <div class="modal-footer"><button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
      </div>
    </div>

    <script>
      // Determine API base: if the page is opened as a local file, fallback to localhost:3000
      const BASE = (window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin);

      const api = (path, opts) => fetch(BASE + path, opts).then(async r => {
        if (!r.ok) {
          let err = r.statusText;
          try { const j = await r.json(); err = j.error || j.message || err } catch (e){}
          throw new Error(err);
        }
        return r.json();
      }).catch(e => { throw e; });

      function showAlert(msg){
        let a = document.getElementById('alertBox');
        if(!a){ a = document.createElement('div'); a.id='alertBox'; a.className='alert alert-warning'; a.style.marginTop='10px'; document.querySelector('.container').prepend(a); }
        a.textContent = msg;
      }

      function downloadCSV(){
        window.location = BASE + '/api/export';
      }

      const el = id => document.getElementById(id);
      const log = msg => { const l = el('log'); l.textContent = new Date().toLocaleTimeString() + ' - ' + msg + '\n' + l.textContent; };
      const showSpinner = (show) => el('spinner').classList.toggle('show', !!show);

      async function loadAccounts(){
        showSpinner(true);
        try{
          const ac = await api('/api/accounts');
          const tbody = document.querySelector('#accountsTable tbody'); tbody.innerHTML='';
          ac.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.user}</td><td>${a.balance}</td><td>${a.currency}</td>`;
            tbody.appendChild(tr);
          });
          log('Loaded accounts');
        }catch(e){log('Error loading accounts: '+e.message)}finally{showSpinner(false)}
      }

      async function loadHistory(){
        try{
          const txs = await api('/api/transactions');
          const list = el('historyList'); list.innerHTML='';
          txs.forEach(t => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<strong>${t.from}</strong> → <strong>${t.to}</strong> : ${t.amount} ${t.currency} <br/><small class="text-muted">${new Date(t.timestamp).toLocaleString()}</small>`;
            list.appendChild(li);
          });
        }catch(e){log('Error loading history: '+e.message)}
      }

      document.getElementById('refreshBtn').addEventListener('click', ()=>{ loadAccounts(); loadHistory(); });

      document.getElementById('transferBtn').addEventListener('click', async () => {
        const user = el('user').value;
        const to = el('to').value;
        const amount = Number(el('amount').value);
        showSpinner(true);
        try{
          const res = await api('/api/action', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user, intent: 'transfer', params: { to, amount } }) });
          log('Transfer success: ' + JSON.stringify(res.transaction));
          if (res.advice) {
            log('Advice: ' + res.advice);
            showAdviceModal(res.advice);
          }
          await loadAccounts();
          await loadHistory();
        }catch(e){log('Transfer error: '+e.message)}finally{showSpinner(false)}
      });

      document.getElementById('exportBtn').addEventListener('click', downloadCSV);
      document.getElementById('clearBtn').addEventListener('click', async () => {
        if (!confirm('Clear all transaction history?')) return;
        showSpinner(true);
        try{
          await fetch(BASE + '/api/transactions/clear', { method: 'POST' });
          await loadHistory();
          log('Cleared transaction history');
        }catch(e){log('Clear error: '+e.message)}finally{showSpinner(false)}
      });

      document.getElementById('filterInput').addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        document.querySelectorAll('#historyList .list-group-item').forEach(li => {
          const text = li.textContent.toLowerCase();
          li.style.display = q && !text.includes(q) ? 'none' : '';
        });
      });

      // theme toggle
      const applyTheme = (dark) => {
        document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
        localStorage.setItem('dark', dark ? '1' : '0');
      };
      document.getElementById('themeBtn').addEventListener('click', ()=>applyTheme(!localStorage.getItem('dark')));
      if (localStorage.getItem('dark') === '1') applyTheme(true);

      function showAdviceModal(text){
        let m = document.getElementById('adviceModalText');
        if (!m) return; m.textContent = text; var modal = new bootstrap.Modal(document.getElementById('adviceModal')); modal.show();
      }

      // init
      loadAccounts(); loadHistory();
    </script>
  </body>
</html>